
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>T-Market</title>
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/moonspam/NanumSquare@2.0/nanumsquare.css">
<link rel="stylesheet" type="text/css" href="/css/page.css">

<script src="/js/menu.js"></script>
<script src="/js/item.js"></script>
<script src="/js/util/utils.js"></script>
<script src="/js/util/paging.js"></script>
<style>

</style>
</head>
<body>
  <div class="container">
  <div id="topDiv" th:include="/page/topDiv.html"></div>
  <div id="header" th:include="|/page/${root.type}/${root.id}/header-1.html|"></div>
  <div class="content">
    <div id="itemNavi1"></div>
    <div id="itemNavi2Wrap">
      <div id="itemNavi2"></div>
    </div>
    <table id="itemDivWrap">
      <tr><td><div id="itemsDiv"></div></td></tr>
      <tr><td><div id="paging"></div></td></tr>
    </table>
    <div id="contentDiv"></div>
  </div>
</div>
</body>

<script th:inline="javascript">
  const root = /*[[${root}]]*/ null;
  
  let style = JSON.parse(root.style);
  const itemsDiv = $("#itemsDiv");
  const itemDivWrap = $("#itemDivWrap");
  const contentDiv = $("#contentDiv");
  let pd = new PagingData();

  function updateItems() {
    itemsDiv.empty();
    itemDivWrap.css("display","block");
    contentDiv.css("display","none");
    $.get("/getPagingItems",pd.toParam())
    .done((resData=>{
      pd.setPagingData(resData);
      const grid = new ItemGrid(root.id, style);
      grid.addItemCell = addItemCell;
      grid.setItems(pd.data);
      $("#paging").empty().append(createPaging(pd,updateItems));
      itemsDiv.append(grid.div);
    })).fail(()=>console.log("Ajax Fail"));
  }

  function searchItems() {
    pd.setSearch($(".search-input").val());
    changeFilter(true);
  }


  function movePath(path, pathName) {
    if(!path) {
      path = root.path;
      pathName = root.pathName;
    }
    pd.setPath(path);
    $("#itemNavi1").empty();
    const sp = path.split("/");
    const spn = pathName.split("/");
    let lp = "";
    let lpn = "";
    for(let i=1; i<spn.length; i++){
      lp += "/"+sp[i];
      lpn += "/"+spn[i];
      $("#itemNavi1").append(createALink(lp,lpn,spn[i])," > ");
    }
    updateItems();
  }
  
  function addItemCell(item) {
    this.items.push(item);
    const cell = {};
    cell.div = $("<div class='itemCell'></div>");
    cell.div.click(()=>{
      itemDivWrap.css("display","none");
      contentDiv.empty().load(`/page/content/${root.id}/${item.id}`);
      contentDiv.css("display","block");
    });
    cell.div.css({width:this.cw, height:this.ch});
    cell.item = item;
    cell.image = $(`<img class='itemImg' src='/resources/images/${item.imagePath}'/>`);
    cell.image.css({width:this.iw, height:this.ih});
    
    const oriPrice = $("<span>");
    cell.div.append(cell.image,`<br>${sliceText(item.name,this.style.sliceText)}<br>`,oriPrice);
    oriPrice.text("￦ "+item.price.toLocaleString());
    if(item.discount > 0) {
      oriPrice.addClass("cancel");
      const dcPrice = "￦ "+ (item.dcPrice).toLocaleString();
      cell.div.append(`<br>-${item.discount}% ${dcPrice}`);
    }
    this.div.append(cell.div);
  }

  function openCart(){
    contentDiv.empty().load(`/page/cart/${root.id}`);
    contentDiv.css("display","block");
    itemDivWrap.css("display","none");
  }

  $(()=>{
    $("#title").append(createTitle(root.name, "100%", 150, 45,"/page/"+root.id));
    pd.setStyle(style);
    createMenu((path, pathName)=>movePath(path, pathName));
    movePath();
    changeFilter();
  });

  function createALink(path, pathName, spn){
    const link = $(`<a class='naviLink'>${spn}</a>`);
    link.click(()=>movePath(path,pathName));
    return link;
  }

</script>

</html>